{
  "Parameters": {
    "PhoneNumber": {
      "Type": "String",
      "Default": "+31683965742"
    }
  },
  "Resources": {
    "smsuser": {
      "Type": "AWS::IAM::User"
    },
    "smsgroup": {
      "Type": "AWS::IAM::Group"
    },
    "Users": {
      "Type": "AWS::IAM::UserToGroupAddition",
      "Properties": {
        "GroupName": {
          "Ref": "smsgroup"
        },
        "Users": [
          {
            "Ref": "smsuser"
          }
        ]
      }
    },
    "smspolicy": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "smspolicy",
        "PolicyDocument": {
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [
                "sns:Publish",
                "sns:SetSMSAttributes"
              ],
              "Resource": "*"
            }
          ]
        },
        "Groups": [
          {
            "Ref": "smsgroup"
          }
        ]
      }
    },
    "smsaccesskey": {
      "Type": "AWS::IAM::AccessKey",
      "Properties": {
        "UserName": {
          "Ref": "smsuser"
        }
      }
    },
    "callSmsFunction": {
      "DependsOn": ["SMSFunction","smsaccesskey","SimonSaysCognitoIdentityPool"]
,      "Type": "Custom::SMSFunction",
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "SMSFunction",
            "Arn"
          ]
        },
        "CognitoPool": {
          "Ref": "SimonSaysCognitoIdentityPool"
        },
        "AccessKey": {
          "Ref": "smsaccesskey"
        },
        "SecretKey": {
          "Fn::GetAtt" : ["smsaccesskey", "SecretAccessKey"]
        },
        "PhoneNumber": {
          "Ref": "PhoneNumber"
        }
      }
    },
    "SMSFunction": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Role": "arn:aws:iam::835483671006:role/SimonSaysLambdaRole",
        "FunctionName": "SMSFunction",
        "Description": "Sends an sms containing an CognitoPoolId",
        "Handler": "index.handler",
        "Runtime": "python3.6",
        "Timeout": 120,
        "Code": {
          "S3Bucket": "awscodepipelinetestbucketcf",
          "S3Key": "sms_function.zip"
        }
      }
    },
    "SimonSaysCognitoIdentityPool": {
      "Type": "AWS::Cognito::IdentityPool",
      "Properties": {
        "IdentityPoolName": "SimonSaysIdentityPool",
        "AllowUnauthenticatedIdentities": true
      }
    }
  }
}
