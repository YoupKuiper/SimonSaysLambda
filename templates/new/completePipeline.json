{
  "TestSimonSaysRepo": {
    "Properties": {
      "RepositoryDescription": "a description",
      "RepositoryName": {
        "Fn::Join": [
          "",
          [
            {
              "Ref": "ProjectName"
            },
            "Repo"
          ]
        ]
      }
    },
    "Type": "AWS::CodeCommit::Repository"
  },
  "TestSimonSaysProject": {
    "Type": "AWS::CodeBuild::Project",
    "Properties": {
      "Name": {
        "Fn::Join": [
          "",
          [
            {
              "Ref": "ProjectName"
            },
            "Build"
          ]
        ]
      },
      "Environment": {
        "Type": "LINUX_CONTAINER",
        "ComputeType": "BUILD_GENERAL1_SMALL",
        "Image": "aws/codebuild/nodejs:8.11.0"
      },
      "ServiceRole": {
        "Fn::Join": [
          "",
          [
            {
              "Ref": "ProjectName"
            },
            "Role"
          ]
        ]
      },
      "Artifacts": {
        "Type": "CODEPIPELINE"
      },
      "Source": {
        "Type": "CODEPIPELINE"
      }
    }
  },
  "TestSimonSaysRole": {
    "Type": "AWS::IAM::Role",
    "Properties": {
      "AssumeRolePolicyDocument": {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Principal": {
              "Service": "codebuild.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
          }
        ]
      },
      "MaxSessionDuration": 3600,
      "Path": "/service-role/",
      "Policies": [
        {
          "PolicyName": "root",
          "PolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "VisualEditor0",
                "Effect": "Allow",
                "Action": "s3:PutObject",
                "Resource": "*"
              }
            ]
          }
        },
        {
          "PolicyName": "TestPolicySven",
          "PolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Resource": [
                  "*"
                ],
                "Action": [
                  "logs:CreateLogGroup",
                  "logs:CreateLogStream",
                  "logs:PutLogEvents"
                ]
              },
              {
                "Effect": "Allow",
                "Resource": [
                  "*"
                ],
                "Action": [
                  "s3:PutObject",
                  "s3:GetObject",
                  "s3:GetObjectVersion"
                ]
              },
              {
                "Effect": "Allow",
                "Action": [
                  "ssm:GetParameters"
                ],
                "Resource": "*"
              }
            ]
          }
        }
      ],
      "RoleName": {
        "Fn::Join": [
          "",
          [
            {
              "Ref": "ProjectName"
            },
            "Role"
          ]
        ]
      }
    }
  },
  "TestSimonSaysPipeLine": {
    "DependsOn": "MyRepo",
    "Name": {
      "Fn::Join": [
        "",
        [
          "codepipeline-",
          {
            "Ref": "ProjectName"
          }
        ]
      ]
    },
    "Properties": {
      "ArtifactStore": {
        "Location": "awscodepipelinetestbucketcf",
        "Type": "S3"
      },
      "RoleArn": "arn:aws:iam::835483671006:role/AWS-CodePipeline-Service",
      "Stages": [
        {
          "Actions": [
            {
              "ActionTypeId": {
                "Category": "Source",
                "Owner": "AWS",
                "Provider": "CodeCommit",
                "Version": "1"
              },
              "Configuration": {
                "BranchName": "master",
                "RepositoryName": {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Ref": "ProjectName"
                      },
                      "Repo"
                    ]
                  ]
                }
              },
              "Name": "SourceAction",
              "OutputArtifacts": [
                {
                  "Name": "SourceOutput"
                }
              ],
              "RunOrder": 1
            }
          ],
          "Name": "Source"
        },
        {
          "Actions": [
            {
              "ActionTypeId": {
                "Category": "Build",
                "Owner": "AWS",
                "Provider": "CodeBuild",
                "Version": "1"
              },
              "Configuration": {
                "ProjectName": {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Ref": "ProjectName"
                      },
                      "Build"
                    ]
                  ]
                }
              },
              "InputArtifacts": [
                {
                  "Name": "SourceOutput"
                }
              ],
              "Name": "CodeBuild",
              "OutputArtifacts": [
                {
                  "Name": "MyAppBuild"
                }
              ],
              "RunOrder": 1
            }
          ],
          "Name": "Build"
        },
        {
          "Actions": [
            {
              "ActionTypeId": {
                "Category": "Deploy",
                "Owner": "AWS",
                "Provider": "CloudFormation",
                "Version": "1"
              },
              "Configuration": {
                "ActionMode": "CHANGE_SET_REPLACE",
                "ChangeSetName": {
                  "Ref": "ChangeSetName"
                },
                "StackName": {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Ref": "ProjectName"
                      },
                      "Stack"
                    ]
                  ]
                },
                "TemplatePath": "MyAppBuild::outputSamTemplate.yaml"
              },
              "InputArtifacts": [
                {
                  "Name": "MyAppBuild"
                }
              ],
              "Name": "Staging",
              "RunOrder": 1
            }
          ],
          "Name": "Staging"
        },
        {
          "Actions": [
            {
              "ActionTypeId": {
                "Category": "Deploy",
                "Owner": "AWS",
                "Provider": "CloudFormation",
                "Version": "1"
              },
              "Configuration": {
                "ActionMode": "CHANGE_SET_EXECUTE",
                "ChangeSetName": {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Ref": "ProjectName"
                      },
                      "ChangeSet"
                    ]
                  ]
                },
                "StackName": {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Ref": "ProjectName"
                      },
                      "Stack"
                    ]
                  ]
                }
              },
              "InputArtifacts": [
                {
                  "Name": "MyAppBuild"
                }
              ],
              "Name": "Deploy",
              "RunOrder": 1
            }
          ],
          "Name": "Deploy"
        }
      ]
    },
    "Type": "AWS::CodePipeline::Pipeline"
  }
}
